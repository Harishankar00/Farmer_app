<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Plant Disease Classifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {font-family: 'Inter', sans-serif;background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);min-height: 100vh;position: relative;overflow-x: hidden;}
        .bg-particles { position: fixed; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none; }
        .particle { position: absolute; background: rgba(255, 255, 255, 0.1); border-radius: 50%; animation: float 8s ease-in-out infinite; }
        .leaf-particle { position: absolute; color: rgba(255, 255, 255, 0.1); font-size: 24px; animation: leafFloat 12s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; } 50% { transform: translateY(-30px) rotate(180deg); opacity: 0.8; } }
        @keyframes leafFloat { 0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); opacity: 0.2; } 33% { transform: translateY(-40px) rotate(120deg) scale(1.2); opacity: 0.6; } 66% { transform: translateY(-20px) rotate(240deg) scale(0.8); opacity: 0.4; } }
        .glass-card { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2); transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2); }
        .input-field { background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .input-field::placeholder { color: rgba(255, 255, 255, 0.6); }
        .input-field:focus { background: rgba(255, 255, 255, 0.15); border-color: rgba(103, 126, 234, 0.8); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(103, 126, 234, 0.3), 0 0 0 3px rgba(103, 126, 234, 0.1); }
        .primary-btn { background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; font-weight: 600; position: relative; overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .primary-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transition: left 0.6s; }
        .primary-btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 10px 35px rgba(102, 126, 234, 0.6); }
        .primary-btn:hover::before { left: 100%; }
        .primary-btn:active { transform: translateY(-1px) scale(1.02); }
        .primary-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .secondary-btn { background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(10px); }
        .secondary-btn:hover { background: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.5); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2); }
        .form-container { transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .form-enter { animation: slideInRight 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .form-exit { animation: slideOutLeft 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideInRight { 0% { opacity: 0; transform: translateX(50px) scale(0.9); } 100% { opacity: 1; transform: translateX(0) scale(1); } }
        @keyframes slideOutLeft { 0% { opacity: 1; transform: translateX(0) scale(1); } 100% { opacity: 0; transform: translateX(-50px) scale(0.9); } }
        .loading-spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .title-glow { background: linear-gradient(135deg, #fff, #e0e7ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: titlePulse 3s ease-in-out infinite; }
        @keyframes titlePulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.9; transform: scale(1.05); } }
        .link-hover { position: relative; transition: all 0.3s ease; }
        .link-hover::after { content: ''; position: absolute; width: 0; height: 2px; bottom: -2px; left: 50%; background: linear-gradient(90deg, #667eea, #764ba2); transition: all 0.3s ease; }
        .link-hover:hover::after { width: 100%; left: 0; }
        .link-hover:hover { transform: translateY(-1px); color: #e0e7ff; }
        .error-message { animation: errorShake 0.6s ease-in-out; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); backdrop-filter: blur(10px); }
        @keyframes errorShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .success-message { animation: successSlide 0.6s ease-out; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); backdrop-filter: blur(10px); }
        @keyframes successSlide { 0% { opacity: 0; transform: translateY(-20px); } 100% { opacity: 1; transform: translateY(0); } }
        .input-group { position: relative; }
        .floating-label { position: absolute; left: 12px; top: 12px; color: rgba(255, 255, 255, 0.6); font-size: 16px; pointer-events: none; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.1); padding: 0 8px; border-radius: 4px; }
        .input-field:focus + .floating-label, .input-field:not(:placeholder-shown) + .floating-label { top: -8px; font-size: 12px; color: rgba(103, 126, 234, 0.9); background: rgba(103, 126, 234, 0.1); }
        .welcome-animation { animation: welcomeBounce 1.5s ease-out; }
        @keyframes welcomeBounce { 0% { opacity: 0; transform: translateY(-30px) scale(0.8); } 50% { opacity: 0.8; transform: translateY(10px) scale(1.1); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
    </style>
</head>
<body>
    <div class="bg-particles"></div>
    
    <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
        <!-- This is the main container for the login/signup forms -->
        <div id="auth-card" class="glass-card p-6 sm:p-8 rounded-3xl w-full max-w-md space-y-6 sm:space-y-8 text-center welcome-animation">
            
            <!-- This is a new loading state that shows if a user is already logged in -->
            <div id="loading-state" class="hidden text-center space-y-4 py-8">
                <div class="loading-spinner mx-auto" style="width: 40px; height: 40px; border-width: 4px;"></div>
                <p class="text-lg font-semibold text-white/90">Authenticating & Redirecting...</p>
            </div>

            <!-- This container holds the actual forms -->
            <div id="form-wrapper">
                <div class="space-y-4">
                    <div class="text-4xl sm:text-5xl mb-4">ðŸŒ¿</div>
                    <h1 class="text-2xl sm:text-3xl font-bold title-glow">
                        Welcome to FarmerApp
                    </h1>
                    <p class="text-white/80 text-sm sm:text-base font-light">
                        Sign in to unlock AI-powered plant disease detection
                    </p>
                </div>

                <!-- Login Form -->
                <div id="auth-container" class="form-container">
                    <form id="loginForm" class="space-y-6">
                        <div class="input-group">
                            <input type="email" id="loginEmail" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none placeholder-transparent" placeholder="Email" required>
                            <label for="loginEmail" class="floating-label">ðŸ“§ Email Address</label>
                        </div>
                        <div class="input-group">
                            <input type="password" id="loginPassword" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none placeholder-transparent" placeholder="Password" required>
                            <label for="loginPassword" class="floating-label">ðŸ”’ Password</label>
                        </div>
                        <button type="submit" id="loginBtn" class="primary-btn w-full py-3 px-6 rounded-xl font-semibold text-base transition-all duration-300">
                            <span id="loginBtnText">âœ¨ Sign In</span>
                            <div id="loginSpinner" class="loading-spinner mx-auto hidden"></div>
                        </button>
                    </form>
                    <div id="loginError" class="mt-4 text-sm text-red-200 font-medium hidden error-message p-3 rounded-xl"></div>
                    <div class="mt-8 space-y-4">
                        <div class="flex items-center">
                            <div class="flex-1 h-px bg-white/20"></div><span class="px-4 text-white/60 text-sm">or</span><div class="flex-1 h-px bg-white/20"></div>
                        </div>
                        <button id="guestSignInBtn" class="secondary-btn w-full py-3 px-6 rounded-xl font-semibold text-base">
                            ðŸ‘¤ Continue as Guest
                        </button>
                        <p class="text-white/80 text-sm">
                            Don't have an account? 
                            <a href="#" id="showSignup" class="text-white font-semibold link-hover">Create Account</a>
                        </p>
                    </div>
                </div>

                <!-- Signup Form (hidden by default) -->
                <div id="signup-container" class="form-container hidden">
                    <form id="signupForm" class="space-y-6">
                        <div class="input-group">
                            <input type="email" id="signupEmail" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none placeholder-transparent" placeholder="Email" required>
                            <label for="signupEmail" class="floating-label">ðŸ“§ Email Address</label>
                        </div>
                        <div class="input-group">
                            <input type="password" id="signupPassword" class="input-field w-full px-4 py-3 rounded-xl focus:outline-none placeholder-transparent" placeholder="Password" required minlength="6">
                            <label for="signupPassword" class="floating-label">ðŸ”’ Create Password</label>
                        </div>
                        <div class="text-xs text-white/60 text-left">Password should be at least 6 characters long</div>
                        <button type="submit" id="signupBtn" class="primary-btn w-full py-3 px-6 rounded-xl font-semibold text-base transition-all duration-300">
                            <span id="signupBtnText">ðŸš€ Create Account</span>
                            <div id="signupSpinner" class="loading-spinner mx-auto hidden"></div>
                        </button>
                    </form>
                    <div id="signupError" class="mt-4 text-sm text-red-200 font-medium hidden error-message p-3 rounded-xl"></div>
                    <div id="signupSuccess" class="mt-4 text-sm text-green-200 font-medium hidden success-message p-3 rounded-xl"></div>
                    <div class="mt-8">
                        <p class="text-white/80 text-sm">
                            Already have an account? 
                            <a href="#" id="showLogin" class="text-white font-semibold link-hover">Sign In</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBPQKIv9hyVZRRwXm-D4w3J_WYblGl0eSg",
            authDomain: "farmer-app-c93e9.firebaseapp.com",
            projectId: "farmer-app-c93e9",
            storageBucket: "farmer-app-c93e9.firebasestorage.app",
            messagingSenderId: "25818831885",
            appId: "1:25818831885:web:9f2e961f3d35b37002c944",
            measurementId: "G-HJNMYGF6ZJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- UI Elements ---
        const authCard = document.getElementById('auth-card');
        const loadingState = document.getElementById('loading-state');
        const formWrapper = document.getElementById('form-wrapper');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const authContainer = document.getElementById('auth-container');
        const signupContainer = document.getElementById('signup-container');
        const showSignupBtn = document.getElementById('showSignup');
        const showLoginBtn = document.getElementById('showLogin');
        const loginError = document.getElementById('loginError');
        const signupError = document.getElementById('signupError');
        const signupSuccess = document.getElementById('signupSuccess');
        const guestSignInBtn = document.getElementById('guestSignInBtn');

        // --- NEW "Bouncer" Logic ---
        // This is the core of our new smart login page.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // A user is logged in! Hide the forms and show the loading spinner.
                formWrapper.classList.add('hidden');
                loadingState.classList.remove('hidden');

                try {
                    const token = await user.getIdToken();
                    
                    // This is the new endpoint we will build in app.py.
                    // It checks if the user has a 'lands' field in Firestore.
                    const response = await fetch('/api/user-status', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('Could not verify user status.');

                    const data = await response.json();

                    // The backend tells us where to go.
                    if (data.has_onboarded) {
                        window.location.replace('/dashboard');
                    } else {
                        window.location.replace('/onboarding');
                    }
                } catch (error) {
                    console.error("Redirection Error:", error);
                    // As a fallback, just send them to the dashboard.
                    window.location.replace('/dashboard');
                }
            } else {
                // No user is logged in. Make sure the login form is visible.
                formWrapper.classList.remove('hidden');
                loadingState.classList.add('hidden');
            }
        });

        // --- Existing Form Logic (with minor changes) ---

        // Sign Up
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupForm.signupEmail.value;
            const password = signupForm.signupPassword.value;

            setLoadingState('signupBtn', 'signupSpinner', 'signupBtnText', true);
            hideMessages();

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // SUCCESS! The onAuthStateChanged listener above will now automatically
                // handle the redirection to the onboarding page. We don't need to do it here.
                showSuccess(signupSuccess, 'ðŸŽ‰ Account created successfully! Redirecting...');
            } catch (error) {
                // Handle errors
                let errorMessage = 'Failed to create account. Please try again.';
                if (error.code === 'auth/email-already-in-use') errorMessage = 'An account with this email already exists.';
                else if (error.code === 'auth/weak-password') errorMessage = 'Password is too weak. Please use at least 6 characters.';
                else if (error.code === 'auth/invalid-email') errorMessage = 'Please enter a valid email address.';
                showError(signupError, errorMessage);
                setLoadingState('signupBtn', 'signupSpinner', 'signupBtnText', false);
            }
        });

        // Sign In
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.loginEmail.value;
            const password = loginForm.loginPassword.value;

            setLoadingState('loginBtn', 'loginSpinner', 'loginBtnText', true);
            hideMessages();

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // SUCCESS! The onAuthStateChanged listener will now automatically handle redirection.
                // No window.location.href is needed here.
            } catch (error) {
                // Handle errors
                let errorMessage = 'Failed to sign in. Please check your credentials.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') errorMessage = 'No account found or incorrect password.';
                else if (error.code === 'auth/wrong-password') errorMessage = 'Incorrect password. Please try again.';
                else if (error.code === 'auth/invalid-email') errorMessage = 'Please enter a valid email address.';
                showError(loginError, errorMessage);
                setLoadingState('loginBtn', 'loginSpinner', 'loginBtnText', false);
            }
        });

        // Guest Sign In
        guestSignInBtn.addEventListener('click', async () => {
            const originalText = guestSignInBtn.textContent;
            guestSignInBtn.textContent = 'ðŸ”„ Signing in...';
            guestSignInBtn.disabled = true;
            hideMessages();

            try {
                await signInAnonymously(auth);
                // SUCCESS! The onAuthStateChanged listener will handle redirection.
            } catch (error) {
                console.error('Guest sign-in error:', error);
                showError(loginError, 'Failed to sign in as guest. Please try again.');
                guestSignInBtn.textContent = originalText;
                guestSignInBtn.disabled = false;
            }
        });

        // --- Helper Functions and Animations (Unchanged) ---
        function createBackgroundElements() {
            const container = document.querySelector('.bg-particles');
            if (container.children.length > 0) return; // Don't recreate if they exist
            const particleCount = window.innerWidth < 640 ? 8 : 15;
            const leafCount = window.innerWidth < 640 ? 3 : 6;
            for (let i = 0; i < particleCount; i++) { const p = document.createElement('div'); p.className = 'particle'; p.style.cssText = `left:${Math.random()*100}%; top:${Math.random()*100}%; width:${Math.random()*8+4}px; height:${p.style.width}; animation-delay:${Math.random()*8}s; animation-duration:${Math.random()*6+6}s;`; container.appendChild(p); }
            const leaves = ['ðŸŒ¿', 'ðŸƒ', 'ðŸŒ±', 'ðŸ€', 'ðŸŒ¾'];
            for (let i = 0; i < leafCount; i++) { const l = document.createElement('div'); l.className = 'leaf-particle'; l.textContent = leaves[Math.floor(Math.random()*leaves.length)]; l.style.cssText = `left:${Math.random()*100}%; top:${Math.random()*100}%; animation-delay:${Math.random()*12}s; animation-duration:${Math.random()*8+10}s;`; container.appendChild(l); }
        }
        createBackgroundElements();
        function switchToSignup() { authContainer.classList.add('form-exit'); setTimeout(() => { authContainer.classList.add('hidden'); signupContainer.classList.remove('hidden'); signupContainer.classList.add('form-enter'); hideMessages(); }, 400); }
        function switchToLogin() { signupContainer.classList.add('form-exit'); setTimeout(() => { signupContainer.classList.add('hidden'); authContainer.classList.remove('hidden'); authContainer.classList.add('form-enter'); hideMessages(); }, 400); }
        function hideMessages() { [loginError, signupError, signupSuccess].forEach(el => el.classList.add('hidden')); }
        function showError(element, message) { element.textContent = message; element.classList.remove('hidden'); }
        function showSuccess(element, message) { element.textContent = message; element.classList.remove('hidden'); }
        function setLoadingState(btnId, spinnerId, textId, loading) { const btn = document.getElementById(btnId); const spinner = document.getElementById(spinnerId); const text = document.getElementById(textId); btn.disabled = loading; if (loading) { text.classList.add('hidden'); spinner.classList.remove('hidden'); } else { text.classList.remove('hidden'); spinner.classList.add('hidden'); } }
        showSignupBtn.addEventListener('click', (e) => { e.preventDefault(); switchToSignup(); });
        showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); switchToLogin(); });
    </script>
</body>
</html>
